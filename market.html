<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMPROVE AFRICA - Agricultural Marketplace</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .product-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .badge {
        position: absolute;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10;
      }
      .badge-organic {
        top: 12px;
        right: 12px;
        background-color: #10b981;
        color: white;
      }
      .badge-featured {
        top: 12px;
        left: 12px;
        background-color: #f59e0b;
        color: white;
      }
      .image-container {
        position: relative;
        padding-top: 75%;
        overflow: hidden;
        background-color: #f3f4f6;
      }
      .image-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }
      .product-card:hover .image-container img {
        transform: scale(1.05);
      }
      .filter-active {
        background-color: #059669;
        color: white;
      }
      .filter-pill {
        transition: all 0.3s ease;
      }
      .filter-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .filter-pill.filter-active {
        background-color: #10b981;
        color: white;
        font-weight: 600;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      }
      .skeleton {
        animation: pulse 1.5s infinite;
        background: linear-gradient(
          90deg,
          #f3f4f6 25%,
          #e5e7eb 50%,
          #f3f4f6 75%
        );
        background-size: 200% 100%;
      }
      @keyframes pulse {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }
      .scroll-smooth {
        scroll-behavior: smooth;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-10">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-4">
          <a href="index.html" class="text-2xl font-bold text-green-600"
            >IMPROVE AFRICA</a
          >
          <div class="hidden md:flex space-x-6">
            <a href="index.html" class="text-gray-600 hover:text-green-600"
              >Home</a
            >
            <a href="about.html" class="text-gray-600 hover:text-green-600"
              >About</a
            >
            <a href="programs.html" class="text-gray-600 hover:text-green-600"
              >Programs</a
            >
            <a href="regions.html" class="text-gray-600 hover:text-green-600"
              >Regions</a
            >
            <a
              href="market.html"
              class="text-gray-600 hover:text-green-600 font-medium"
              >Marketplace</a
            >
            <a href="contact.html" class="text-gray-600 hover:text-green-600"
              >Contact</a
            >
          </div>
          <div class="flex items-center space-x-4">
            <a
              href="login.html"
              id="login-button"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
            >
              Login
            </a>
            <a
              href="#"
              id="logout-button"
              class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-sm hidden"
            >
              Logout
            </a>
            <button class="md:hidden text-gray-600" aria-label="Toggle menu">
              <i class="fas fa-bars text-xl"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Search Section -->
    <section class="bg-gray-100 py-8">
      <div class="container mx-auto px-4">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4"
          >
            <div class="flex-grow">
              <div class="relative">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search products..."
                  class="w-full rounded-lg border border-gray-300 px-4 py-2 pl-10 focus:border-blue-500 focus:outline-none"
                />
                <div
                  class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
                >
                  <i class="fas fa-search text-gray-400"></i>
                </div>
              </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
              <select
                id="categoryFilter"
                class="rounded-lg border border-gray-300 px-4 py-2 bg-white focus:border-blue-500 focus:outline-none cursor-pointer"
                aria-label="Filter by category"
              >
                <option value="">All Categories</option>
                <option value="fruits">Fruits</option>
                <option value="vegetables">Vegetables</option>
                <option value="grains">Grains</option>
                <option value="legumes">Legumes</option>
                <option value="oilseeds">Oilseeds</option>
                <option value="roots-tubers">Roots & Tubers</option>
                <option value="spices">Spices</option>
              </select>
              <select
                id="regionFilter"
                class="rounded-lg border border-gray-300 px-4 py-2 bg-white focus:border-blue-500 focus:outline-none cursor-pointer"
                aria-label="Filter by region"
              >
                <option value="">All Regions</option>
                <option value="Ashanti">Ashanti</option>
                <option value="Brong-Ahafo">Brong-Ahafo</option>
                <option value="Central">Central</option>
                <option value="Eastern">Eastern</option>
                <option value="Greater Accra">Greater Accra</option>
                <option value="Northern">Northern</option>
                <option value="Upper East">Upper East</option>
                <option value="Upper West">Upper West</option>
                <option value="Volta">Volta</option>
                <option value="Western">Western</option>
              </select>
              <button
                id="filterButton"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-300 flex items-center justify-center"
              >
                <i class="fas fa-filter mr-2"></i> Filter
              </button>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <div class="flex items-center">
              <input
                type="checkbox"
                id="organicFilter"
                class="form-checkbox h-4 w-4 text-blue-600"
              />
              <label for="organicFilter" class="ml-2 text-sm text-gray-700"
                >Organic</label
              >
            </div>
            <div class="flex items-center">
              <input
                type="checkbox"
                id="featuredFilter"
                class="form-checkbox h-4 w-4 text-blue-600"
              />
              <label for="featuredFilter" class="ml-2 text-sm text-gray-700"
                >Featured</label
              >
            </div>
            <div class="flex items-center ml-4">
              <span class="text-sm text-gray-700 mr-2">Sort by:</span>
              <select
                id="sortFilter"
                class="text-sm rounded border border-gray-300 px-2 py-1 bg-white focus:border-blue-500 focus:outline-none cursor-pointer"
                aria-label="Sort products by"
              >
                <option value="newest">Newest</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="name-asc">Name: A-Z</option>
                <option value="name-desc">Name: Z-A</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category Filters -->
    <section class="bg-white py-4 sticky top-16 z-40 border-b">
      <div class="container mx-auto px-4">
        <div class="flex overflow-x-auto pb-2 scroll-smooth hide-scrollbar">
          <div class="flex space-x-3">
            <button
              class="filter-pill filter-active bg-green-500 text-white whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-sm font-medium"
              data-category="all"
            >
              All Products
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="grains"
            >
              <i class="fas fa-wheat-alt mr-2"></i>Grains
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="legumes"
            >
              <i class="fas fa-seedling mr-2"></i>Legumes
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="oilseeds"
            >
              <i class="fas fa-leaf mr-2"></i>Oilseeds
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="roots-tubers"
            >
              <i class="fas fa-carrot mr-2"></i>Roots & Tubers
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="fruits"
            >
              <i class="fas fa-apple-alt mr-2"></i>Fruits
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="vegetables"
            >
              <i class="fas fa-pepper-hot mr-2"></i>Vegetables
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="spices"
            >
              <i class="fas fa-mortar-pestle mr-2"></i>Spices
            </button>
            <button
              class="filter-pill whitespace-nowrap px-4 py-2 rounded-full border border-green-500 text-green-700 text-sm font-medium"
              data-category="organic"
            >
              <i class="fas fa-leaf mr-2"></i>Organic Only
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Products Grid -->
    <section class="py-8">
      <div class="container mx-auto px-4">
        <!-- Loading Skeletons -->
        <div
          id="loading"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
        >
          <!-- Skeleton cards will be inserted here -->
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-12">
          <div class="max-w-md mx-auto">
            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg">
              No products found. Try adjusting your filters.
            </p>
          </div>
        </div>

        <!-- Products Container -->
        <div
          id="products-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
        >
          <!-- Products will be inserted here -->
        </div>
      </div>
    </section>

    <!-- Product Modal -->
    <div
      id="product-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold">Product Details</h3>
          <button
            id="modal-close"
            class="text-gray-500 hover:text-gray-700"
            aria-label="Close modal"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-content p-6">
          <!-- Product details will be inserted here by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
      <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">IMPROVE AFRICA</h3>
            <p class="text-gray-300">
              Connecting farmers and buyers across Ghana with high-quality
              agricultural raw materials.
            </p>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="index.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="about.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >About Us</a
                >
              </li>
              <li>
                <a
                  href="programs.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >Programs</a
                >
              </li>
              <li>
                <a
                  href="regions.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >Regions</a
                >
              </li>
              <li>
                <a
                  href="market.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >Marketplace</a
                >
              </li>
              <li>
                <a
                  href="contact.html"
                  class="text-gray-300 hover:text-white transition-colors"
                  >Contact</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">Contact Us</h3>
            <p class="text-gray-300 mb-2">
              <i class="fas fa-envelope mr-2"></i>Email: info@improveafrica.com
            </p>
            <p class="text-gray-300 mb-2">
              <i class="fas fa-phone mr-2"></i>Phone: +233 123 456 789
            </p>
            <p class="text-gray-300">
              <i class="fas fa-map-marker-alt mr-2"></i>Accra, Ghana
            </p>
          </div>
        </div>
        <div
          class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-300"
        >
          <p>&copy; 2024 IMPROVE AFRICA. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"
    >
      <div
        class="bg-white h-full w-64 p-4 transform transition-transform duration-300 ease-in-out -translate-x-full"
      >
        <div class="flex justify-between items-center mb-6">
          <span class="text-lg font-bold text-green-600">IMPROVE AFRICA</span>
          <button id="close-menu" class="text-gray-500" aria-label="Close menu">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex flex-col space-y-4">
          <a
            href="index.html"
            class="text-gray-600 hover:text-green-600 py-2 border-b border-gray-100"
            >Home</a
          >
          <a
            href="about.html"
            class="text-gray-600 hover:text-green-600 py-2 border-b border-gray-100"
            >About</a
          >
          <a
            href="programs.html"
            class="text-gray-600 hover:text-green-600 py-2 border-b border-gray-100"
            >Programs</a
          >
          <a
            href="regions.html"
            class="text-gray-600 hover:text-green-600 py-2 border-b border-gray-100"
            >Regions</a
          >
          <a
            href="market.html"
            class="text-gray-600 hover:text-green-600 font-medium py-2 border-b border-gray-100"
            >Marketplace</a
          >
          <a
            href="contact.html"
            class="text-gray-600 hover:text-green-600 py-2 border-b border-gray-100"
            >Contact</a
          >
        </div>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Get DOM elements
        const productsContainer = document.getElementById("products-container");
        const loadingContainer = document.getElementById("loading");
        const noResultsMessage = document.getElementById("no-results");
        const searchInput = document.getElementById("searchInput");
        const regionFilter = document.getElementById("regionFilter");
        const categoryFilter = document.getElementById("categoryFilter");
        const organicFilter = document.getElementById("organicFilter");
        const featuredFilter = document.getElementById("featuredFilter");
        const sortFilter = document.getElementById("sortFilter");
        const filterButton = document.getElementById("filterButton");
        const productModal = document.getElementById("product-modal");
        const modalClose = document.getElementById("modal-close");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");

        let allProducts = [];
        let filteredProducts = [];

        // Show login/logout buttons based on authentication
        function updateAuthButtons() {
          const token = localStorage.getItem("token");
          if (token) {
            loginButton.textContent = "Logout";
            loginButton.onclick = () => {
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              window.location.reload();
            };
            logoutButton.classList.remove("hidden");
            fetchProducts(); // Fetch products when user is logged in
          } else {
            loginButton.textContent = "Login";
            loginButton.onclick = () => {
              window.location.href = "login.html";
            };
            loadingContainer.classList.add("hidden");
            noResultsMessage.classList.remove("hidden");
            noResultsMessage.innerHTML = `
              <div class="text-center py-8">
                <img src="assets/images/login-required.svg" alt="Login required" class="w-32 h-32 mx-auto mb-4 opacity-60">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Login Required</h3>
                <p class="text-gray-600 mb-4">Please <a href="login.html" class="text-blue-600 hover:underline">log in</a> to view available products.</p>
                <a href="login.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors inline-block">
                  Login to Continue
                </a>
              </div>
            `;
            logoutButton.classList.add("hidden");
          }
        }

        updateAuthButtons();

        // Handle logout
        logoutButton.addEventListener("click", () => {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });

        // Function to fetch products from API
        async function fetchProducts() {
          console.log("Fetching products...");

          // Create loading skeletons
          productsContainer.innerHTML = "";
          for (let i = 0; i < 8; i++) {
            productsContainer.innerHTML += createSkeletonCard();
          }

          loadingContainer.classList.remove("hidden");
          noResultsMessage.classList.add("hidden");

          // Check for authentication token
          const token = localStorage.getItem("token");
          if (!token) {
            loadingContainer.classList.add("hidden");
            noResultsMessage.classList.remove("hidden");
            noResultsMessage.innerHTML = `
              <div class="text-center py-8">
                <img src="assets/images/login-required.svg" alt="Login required" class="w-32 h-32 mx-auto mb-4 opacity-60">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Login Required</h3>
                <p class="text-gray-600 mb-4">Please <a href="login.html" class="text-blue-600 hover:underline">log in</a> to view available products.</p>
                <a href="login.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors inline-block">
                  Login to Continue
                </a>
              </div>
            `;
            return;
          }

          try {
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            const url = `/api/products?_=${timestamp}`;

            console.log("Fetching products from:", url);
            const response = await fetch(url, {
              headers: {
                Authorization: `Bearer ${token}`,
                "Cache-Control": "no-cache, no-store",
              },
            });

            if (!response.ok) {
              throw new Error(
                `Failed to fetch products: ${response.status} ${response.statusText}`
              );
            }

            // First check if there's content
            const text = await response.text();
            console.log("Response text length:", text.length);

            if (!text || text.trim() === "") {
              throw new Error("Empty response from server");
            }

            // Then parse as JSON
            const responseData = JSON.parse(text);
            console.log("Response data:", responseData);

            if (!responseData.success) {
              throw new Error(
                responseData.message || "Failed to fetch products"
              );
            }

            // Extract products from the response data
            allProducts = responseData.data || [];
            console.log("Products fetched:", allProducts);

            // Initialize with all products
            filteredProducts = [...allProducts];
            applyFilters();
          } catch (error) {
            console.error("Error fetching products:", error);
            loadingContainer.classList.add("hidden");
            noResultsMessage.classList.remove("hidden");
            noResultsMessage.innerHTML = `
              <div class="text-center py-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Error Loading Products</h3>
                <p class="text-gray-600 mb-4">${
                  error.message || "An unexpected error occurred."
                }</p>
                <button onclick="fetchProducts()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors inline-block">
                  Try Again
                </button>
              </div>
            `;
          }
        }

        // Apply all filters to products
        function applyFilters() {
          const searchTerm = searchInput.value.toLowerCase();
          const regionValue = regionFilter.value;
          const categoryValue = categoryFilter.value;
          const isOrganic = organicFilter.checked;
          const isFeatured = featuredFilter.checked;
          const sortValue = sortFilter.value;

          filteredProducts = allProducts.filter((product) => {
            // Search term filter
            const matchesSearch =
              searchTerm === "" ||
              product.name.toLowerCase().includes(searchTerm) ||
              (product.description &&
                product.description.toLowerCase().includes(searchTerm));

            // Region filter
            const matchesRegion =
              regionValue === "" ||
              (product.location && product.location.region === regionValue);

            // Category filter
            const matchesCategory =
              categoryValue === "" || product.category === categoryValue;

            // Organic filter - check if certifications array includes "Organic"
            const matchesOrganic =
              !isOrganic ||
              (product.certifications &&
                product.certifications.some(
                  (cert) => cert.toLowerCase() === "organic"
                ));

            // Featured filter - check for featured status
            const matchesFeatured =
              !isFeatured || product.status === "featured";

            return (
              matchesSearch &&
              matchesRegion &&
              matchesCategory &&
              matchesOrganic &&
              matchesFeatured
            );
          });

          // Sort products
          if (sortValue === "price-low") {
            filteredProducts.sort((a, b) => a.price - b.price);
          } else if (sortValue === "price-high") {
            filteredProducts.sort((a, b) => b.price - a.price);
          } else if (sortValue === "name-asc") {
            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
          } else if (sortValue === "name-desc") {
            filteredProducts.sort((a, b) => b.name.localeCompare(a.name));
          } else if (sortValue === "newest") {
            filteredProducts.sort(
              (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            );
          }

          displayProducts(filteredProducts);
        }

        // Event listeners for filters
        searchInput.addEventListener("input", applyFilters);
        regionFilter.addEventListener("change", applyFilters);
        categoryFilter.addEventListener("change", applyFilters);
        organicFilter.addEventListener("change", applyFilters);
        featuredFilter.addEventListener("change", applyFilters);
        sortFilter.addEventListener("change", applyFilters);
        filterButton.addEventListener("click", applyFilters);

        // Event listeners for category filter pills
        document.querySelectorAll(".filter-pill").forEach((pill) => {
          pill.addEventListener("click", function () {
            // Remove active class from all pills
            document.querySelectorAll(".filter-pill").forEach((p) => {
              p.classList.remove("filter-active");
              p.classList.remove("bg-green-500");
              p.classList.remove("text-white");
              p.classList.add("text-green-700");
            });

            // Add active class to clicked pill
            this.classList.add("filter-active");
            this.classList.add("bg-green-500");
            this.classList.add("text-white");
            this.classList.remove("text-green-700");

            const category = this.getAttribute("data-category");

            if (category === "all") {
              categoryFilter.value = "";
            } else if (category === "organic") {
              organicFilter.checked = true;
            } else {
              categoryFilter.value = category;
            }

            applyFilters();
          });
        });

        // Function to display products as cards
        function displayProducts(products) {
          loadingContainer.classList.add("hidden");
          productsContainer.innerHTML = "";

          if (products.length === 0) {
            noResultsMessage.classList.remove("hidden");
            noResultsMessage.textContent =
              "No products found matching your filters.";
            return;
          }

          noResultsMessage.classList.add("hidden");

          products.forEach((product) => {
            // Create certification badges
            let certificationBadges = "";

            // Check for certifications in the certifications array
            if (product.certifications && product.certifications.length > 0) {
              product.certifications.forEach((cert) => {
                if (cert.toLowerCase() === "organic") {
                  certificationBadges += `<span class="badge bg-green-100 text-green-800 mr-1 mb-1">Organic</span>`;
                } else {
                  certificationBadges += `<span class="badge bg-blue-100 text-blue-800 mr-1 mb-1">${cert}</span>`;
                }
              });
            }

            // Special badge for featured products
            if (product.status === "featured") {
              certificationBadges += `<span class="badge bg-yellow-100 text-yellow-800 mr-1 mb-1">Featured</span>`;
            }

            // Set default image URL if no product images
            const imageUrl =
              product.images && product.images.length > 0
                ? product.images[0]
                : "assets/images/product-placeholder.jpg";

            // Format harvest date
            const harvestDate = product.harvestDate
              ? new Date(product.harvestDate).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })
              : "Not specified";

            // Get location information safely
            const locationCity =
              product.location && product.location.city
                ? product.location.city
                : "Unknown";
            const locationRegion =
              product.location && product.location.region
                ? product.location.region
                : "Unknown";
            const locationCountry =
              product.location && product.location.country
                ? product.location.country
                : "Ghana";

            // Create product card
            const productCard = `
              <div class="product-card relative bg-white rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow">
                <div class="absolute top-2 left-2 flex flex-wrap z-10">${certificationBadges}</div>
                <div class="image-container h-48 relative overflow-hidden">
                  <img
                    src="${imageUrl}"
                    alt="${product.name}"
                    class="w-full h-full object-cover transition transform hover:scale-105"
                    loading="lazy"
                  />
                </div>
                <div class="p-4 flex flex-col h-[calc(100%-12rem)] flex-grow">
                  <div class="mb-2">
                    <h3 class="text-lg font-semibold leading-tight">${
                      product.name
                    }
                      <span class="text-blue-600 whitespace-nowrap ml-2">$${
                        product.price
                      }/${product.unit || "kg"}</span>
                    </h3>
                    <p class="text-sm text-gray-600">${locationCity}, ${locationRegion}</p>
                  </div>
                  <p class="text-gray-700 mb-4 text-sm line-clamp-2 flex-grow">${
                    product.description || "No description available"
                  }</p>
                  <div class="mt-auto flex justify-between items-center">
                    <span class="text-sm text-gray-500">${product.quantity} ${
              product.unit || "kg"
            }</span>
                    <button
                      class="view-details bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm transition-colors"
                      data-product-id="${product._id}"
                    >
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            `;

            productsContainer.innerHTML += productCard;
          });

          // Add event listeners to View Details buttons
          document.querySelectorAll(".view-details").forEach((button) => {
            button.addEventListener("click", function () {
              const productId = this.getAttribute("data-product-id");
              const product = products.find((p) => p._id === productId);
              showProductDetails(product);
            });
          });
        }

        // Create skeleton loading card
        function createSkeletonCard() {
          return `
            <div class="product-card bg-white rounded-lg overflow-hidden shadow">
              <div class="image-container skeleton h-48"></div>
              <div class="p-4">
                <div class="skeleton h-6 w-3/4 mb-2 rounded"></div>
                <div class="skeleton h-4 w-1/2 mb-4 rounded"></div>
                <div class="skeleton h-16 w-full mb-4 rounded"></div>
                <div class="flex justify-between items-center">
                  <div class="skeleton h-4 w-1/4 rounded"></div>
                  <div class="skeleton h-8 w-1/4 rounded"></div>
                </div>
              </div>
            </div>
          `;
        }

        // Function to display product details in modal
        function showProductDetails(product) {
          if (!product) return;

          // Format harvest date
          const harvestDate = product.harvestDate
            ? new Date(product.harvestDate).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            : "Not specified";

          // Create certification badges
          let certificationBadges = "";

          // Check for certifications in the certifications array
          if (product.certifications && product.certifications.length > 0) {
            product.certifications.forEach((cert) => {
              if (cert.toLowerCase() === "organic") {
                certificationBadges += `<span class="badge bg-green-100 text-green-800 mr-2 px-2 py-1 rounded text-sm">Organic</span>`;
              } else {
                certificationBadges += `<span class="badge bg-blue-100 text-blue-800 mr-2 px-2 py-1 rounded text-sm">${cert}</span>`;
              }
            });
          }

          // Special badge for featured products
          if (product.status === "featured") {
            certificationBadges += `<span class="badge bg-yellow-100 text-yellow-800 mr-2 px-2 py-1 rounded text-sm">Featured</span>`;
          }

          // Get main image and additional images
          const mainImage =
            product.images && product.images.length > 0
              ? product.images[0]
              : "assets/images/product-placeholder.jpg";

          let additionalImagesHtml = "";
          if (product.images && product.images.length > 1) {
            additionalImagesHtml = '<div class="grid grid-cols-4 gap-2 mt-3">';
            for (let i = 0; i < Math.min(4, product.images.length); i++) {
              additionalImagesHtml += `
                <div class="image-container bg-gray-100 rounded overflow-hidden shadow-sm">
                  <img 
                    src="${product.images[i]}" 
                    alt="${product.name} image ${i + 1}" 
                    class="w-full h-16 object-cover"
                  />
                </div>
              `;
            }
            additionalImagesHtml += "</div>";
          }

          // Get location information safely
          const locationCity =
            product.location && product.location.city
              ? product.location.city
              : "Unknown";
          const locationRegion =
            product.location && product.location.region
              ? product.location.region
              : "Unknown";
          const locationCountry =
            product.location && product.location.country
              ? product.location.country
              : "Ghana";

          productModal.querySelector(".modal-content").innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <div class="image-container rounded-lg overflow-hidden shadow-md bg-gray-100 h-64 md:h-80">
                  <img 
                    src="${mainImage}" 
                    alt="${product.name}" 
                    class="w-full h-full object-cover"
                  />
                </div>
                ${additionalImagesHtml}
              </div>
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h2 class="text-2xl font-bold">${product.name}</h2>
                  <div>${certificationBadges}</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Price:</span>
                    <span class="text-xl font-bold text-blue-600">$${
                      product.price
                    }/${product.unit || "kg"}</span>
                  </div>
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Available Quantity:</span>
                    <span class="font-medium">${product.quantity} ${
            product.unit || "kg"
          }</span>
                  </div>
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Status:</span>
                    <span class="font-medium capitalize">${
                      product.status || "Available"
                    }</span>
                  </div>
                </div>
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">Description</h3>
                  <p class="text-gray-700">${
                    product.description || "No description available"
                  }</p>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                  <div class="bg-gray-50 p-3 rounded-md">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-map-marker-alt text-gray-500 mr-2"></i>
                      <span class="text-sm font-medium">Location</span>
                    </div>
                    <p class="text-gray-700">${locationCity}, ${locationRegion}, ${locationCountry}</p>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-md">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>
                      <span class="text-sm font-medium">Harvest Date</span>
                    </div>
                    <p class="text-gray-700">${harvestDate}</p>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-md">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-star text-gray-500 mr-2"></i>
                      <span class="text-sm font-medium">Quality Grade</span>
                    </div>
                    <p class="text-gray-700">${
                      product.quality || "Not specified"
                    }</p>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-md">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-user text-gray-500 mr-2"></i>
                      <span class="text-sm font-medium">Seller</span>
                    </div>
                    <p class="text-gray-700">${
                      product.seller && product.seller.name
                        ? product.seller.name
                        : "Contact for details"
                    }</p>
                  </div>
                </div>
                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors"
                  data-product-id="${product._id}">
                  <i class="fas fa-envelope mr-2"></i> Contact Seller
                </button>
              </div>
            </div>
          `;

          productModal.classList.remove("hidden");
        }

        // Close modal when clicked outside or on close button
        modalClose.addEventListener("click", function () {
          productModal.classList.add("hidden");
        });

        window.addEventListener("click", function (event) {
          if (event.target === productModal) {
            productModal.classList.add("hidden");
          }
        });

        // Initial fetch of products
        fetchProducts();

        // Mobile menu functionality
        const mobileMenuButton = document.querySelector(".md\\:hidden");
        const mobileMenu = document.getElementById("mobile-menu");
        const closeMenuButton = document.getElementById("close-menu");

        mobileMenuButton.addEventListener("click", function () {
          mobileMenu.classList.remove("hidden");
          // Add a small delay to apply the transform
          setTimeout(() => {
            mobileMenu.querySelector("div").classList.add("translate-x-0");
          }, 10);
        });

        closeMenuButton.addEventListener("click", function () {
          mobileMenu.querySelector("div").classList.remove("translate-x-0");
          // Wait for the transition to complete before hiding
          setTimeout(() => {
            mobileMenu.classList.add("hidden");
          }, 300);
        });

        // Close the mobile menu when clicking outside of it
        mobileMenu.addEventListener("click", function (event) {
          if (event.target === mobileMenu) {
            mobileMenu.querySelector("div").classList.remove("translate-x-0");
            setTimeout(() => {
              mobileMenu.classList.add("hidden");
            }, 300);
          }
        });

        // Contact seller button handler
        document.querySelectorAll(".modal-content button").forEach((button) => {
          button.addEventListener("click", async function () {
            const product = products.find(
              (p) => p._id === this.getAttribute("data-product-id")
            );
            if (!product || !product.seller) {
              alert(
                "Seller information not available. Please try again later."
              );
              return;
            }

            // You can implement your own contact logic here
            // For example, open a contact form modal or redirect to a messaging page
            const sellerId = product.seller._id || product.seller;
            const currentUser = JSON.parse(
              localStorage.getItem("user") || "{}"
            );

            if (!currentUser || !currentUser._id) {
              alert("You need to be logged in to contact the seller.");
              window.location.href = "login.html";
              return;
            }

            alert(
              `Contact function will be implemented soon. You're trying to contact the seller of ${product.name}.`
            );

            // For future implementation, you might want to:
            // 1. Create a message in your database
            // 2. Send a notification to the seller
            // 3. Redirect to a messaging interface
          });
        });
      });
    </script>
  </body>
</html>
