<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agricultural Raw Materials Marketplace - Database Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        color: #1e4d8c;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      button:hover {
        background-color: #45a049;
      }
      pre {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      .error {
        color: #f44336;
        font-weight: bold;
      }
      #log {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>Agricultural Raw Materials Marketplace - Database Setup</h1>

    <p>
      This tool will help you set up the necessary database tables for the
      Agricultural Raw Materials Marketplace.
    </p>

    <div>
      <label for="supabase-url">Supabase URL:</label>
      <input
        type="text"
        id="supabase-url"
        style="width: 100%; padding: 8px; margin: 5px 0"
        value="https://jgyakynekveyzyeipihg.supabase.co"
      />
    </div>

    <div>
      <label for="supabase-key">Supabase Anon Key:</label>
      <input
        type="text"
        id="supabase-key"
        style="width: 100%; padding: 8px; margin: 5px 0"
        value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpneWFreW5la3ZleXp5ZWlwaWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxMjY1MDQsImV4cCI6MjA1NzcwMjUwNH0.Y6-r7-Bba3J4BN2NFGeqKRcrpeeZYJoPgu1ZS33XKns"
      />
    </div>

    <button onclick="createTables()">Create Tables</button>
    <button onclick="seedDatabase()">Seed Database</button>
    <button onclick="testConnection()">Test Connection</button>

    <div id="log"></div>

    <script>
      // Initialize Supabase client
      let supabaseClient;

      function initSupabase() {
        const url = document.getElementById("supabase-url").value;
        const key = document.getElementById("supabase-key").value;

        if (!url || !key) {
          logMessage("Please enter Supabase URL and Anon Key", "error");
          return null;
        }

        try {
          supabaseClient = supabase.createClient(url, key);
          return supabaseClient;
        } catch (error) {
          logMessage(`Error initializing Supabase: ${error.message}`, "error");
          return null;
        }
      }

      async function testConnection() {
        const client = initSupabase();
        if (!client) return;

        logMessage("Testing connection to Supabase...", "info");

        try {
          const { data, error } = await client
            .from("Agricultural Raw Materials Marketplace")
            .select("count");

          if (error) {
            if (error.message.includes("does not exist")) {
              logMessage(
                "Connection successful, but Agricultural Raw Materials Marketplace table does not exist yet.",
                "info"
              );
            } else {
              logMessage(
                `Error connecting to Supabase: ${error.message}`,
                "error"
              );
            }
          } else {
            logMessage(
              "Connection successful! Agricultural Raw Materials Marketplace table exists.",
              "success"
            );
            logMessage(
              `Found ${data[0].count} products in the database.`,
              "info"
            );
          }
        } catch (error) {
          logMessage(`Exception testing connection: ${error.message}`, "error");
        }
      }

      async function createTables() {
        const client = initSupabase();
        if (!client) return;

        logMessage(
          "Creating Agricultural Raw Materials Marketplace table...",
          "info"
        );

        try {
          // Create products table using SQL query
          const { error } = await client.rpc("exec", {
            query: `
            CREATE TABLE IF NOT EXISTS "Agricultural Raw Materials Marketplace" (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255) NOT NULL,
              type VARCHAR(100) NOT NULL,
              region VARCHAR(255),
              price INTEGER NOT NULL,
              price_max INTEGER,
              moq INTEGER,
              stock INTEGER DEFAULT 0,
              is_organic BOOLEAN DEFAULT FALSE,
              image_url VARCHAR(255),
              description TEXT,
              created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
              updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
          `,
          });

          if (error) {
            logMessage(`Error creating table: ${error.message}`, "error");
            logMessage("Trying alternative method...", "info");

            // Try direct SQL approach
            const response = await fetch(`${client.supabaseUrl}/rest/v1/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: client.supabaseKey,
                Authorization: `Bearer ${client.supabaseKey}`,
              },
              body: JSON.stringify({
                query: `
                CREATE TABLE IF NOT EXISTS "Agricultural Raw Materials Marketplace" (
                  id SERIAL PRIMARY KEY,
                  name VARCHAR(255) NOT NULL,
                  type VARCHAR(100) NOT NULL,
                  region VARCHAR(255),
                  price INTEGER NOT NULL,
                  price_max INTEGER,
                  moq INTEGER,
                  stock INTEGER DEFAULT 0,
                  is_organic BOOLEAN DEFAULT FALSE,
                  image_url VARCHAR(255),
                  description TEXT,
                  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
              `,
              }),
            });

            if (!response.ok) {
              logMessage(
                `Error creating table via REST API: ${await response.text()}`,
                "error"
              );
              logMessage(
                "Please create the table manually using the Supabase dashboard.",
                "info"
              );
              return;
            }
          }

          logMessage("Table created successfully!", "success");
        } catch (error) {
          logMessage(`Exception creating tables: ${error.message}`, "error");
        }
      }

      async function seedDatabase() {
        const client = initSupabase();
        if (!client) return;

        logMessage("Seeding database with sample products...", "info");

        const sampleProducts = [
          {
            name: "Obatanpa Maize",
            type: "Maize",
            region: "Bono East",
            price: 280,
            price_max: 320,
            moq: 20,
            stock: 500,
            is_organic: false,
            description: "High-yielding, quality protein maize (QPM)",
            image_url:
              "https://images.unsplash.com/photo-1551754655-cd27e38d2076?q=80&w=1000",
          },
          {
            name: "Jasmine Rice",
            type: "Rice",
            region: "Volta",
            price: 800,
            price_max: 950,
            moq: 15,
            stock: 300,
            is_organic: false,
            description: "Aromatic long-grain rice variety",
            image_url:
              "https://images.unsplash.com/photo-1586201375761-83865001e8ac?q=80&w=1000",
          },
          {
            name: "Pearl Millet",
            type: "Millet",
            region: "Northern",
            price: 400,
            price_max: 450,
            moq: 10,
            stock: 200,
            is_organic: true,
            description: "Traditional drought-resistant grain",
            image_url:
              "https://images.unsplash.com/photo-1603431777007-61db4494a034?q=80&w=1000",
          },
          {
            name: "Red Sorghum",
            type: "Sorghum",
            region: "Upper West",
            price: 350,
            price_max: 400,
            moq: 15,
            stock: 250,
            is_organic: false,
            description: "Used for food and brewing",
            image_url:
              "https://images.unsplash.com/photo-1603431777007-61db4494a034?q=80&w=1000",
          },
          {
            name: "Fonio",
            type: "Fonio",
            region: "Savannah",
            price: 900,
            price_max: 1100,
            moq: 5,
            stock: 100,
            is_organic: true,
            description: "Ancient indigenous super grain",
            image_url:
              "https://images.unsplash.com/photo-1586201375761-83865001e8ac?q=80&w=1000",
          },
        ];

        try {
          const { data, error } = await client
            .from("Agricultural Raw Materials Marketplace")
            .insert(sampleProducts)
            .select();

          if (error) {
            logMessage(`Error seeding products: ${error.message}`, "error");
            return;
          }

          logMessage(
            `Added ${data.length} sample products successfully!`,
            "success"
          );
        } catch (error) {
          logMessage(`Exception seeding database: ${error.message}`, "error");
        }
      }

      function logMessage(message, type = "info") {
        const log = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement("div");
        entry.className = type;
        entry.textContent = `[${timestamp}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      // Get all maize products
      const getMaizeProducts = async () => {
        const { data, error } = await supabase
          .from("Agricultural Raw Materials Marketplace")
          .select("*")
          .eq("type", "Maize");

        if (error) console.error("Error fetching maize products:", error);
        return data;
      };

      // Get products in a specific price range
      const getAffordableProducts = async () => {
        const { data, error } = await supabase
          .from("Agricultural Raw Materials Marketplace")
          .select("*")
          .lte("price", 500);

        if (error) console.error("Error fetching affordable products:", error);
        return data;
      };

      // Get organic products only
      const getOrganicProducts = async () => {
        const { data, error } = await supabase
          .from("Agricultural Raw Materials Marketplace")
          .select("*")
          .eq("is_organic", true);

        if (error) console.error("Error fetching organic products:", error);
        return data;
      };
    </script>
  </body>
</html>
